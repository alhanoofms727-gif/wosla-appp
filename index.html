<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙˆØµÙ„Ø© â€“ ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ÙˆØ³ÙŠÙ‚ÙŠ</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© -->
  <style>
    :root{--bg:#0f172a;--fg:#e2e8f0;--brand:#22d3ee;}
    *{box-sizing:border-box}
    body{
    <!-- ğŸª„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
<video id="video" autoplay playsinline style="
  width: 100%;
  max-width: 500px;
  border: 2px solid white;
  border-radius: 10px;
  margin-top: 20px;
"></video>

<script>
  async function startCamera() {
    try {
      const constraints = {
        video: {
          facingMode: 'user', // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
          width: { ideal: 640 },
          height: { ideal: 480 }
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      document.getElementById('video').srcObject = stream;
    } catch (error) {
      console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
      alert('âŒ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ø¬Ù‡Ø§Ø².');
    }
  }

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    startCamera();
  } else {
    alert('âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
  }
</script>  margin:0;background:var(--bg);color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Tajawal, Arial, sans-serif;
      text-align:center
    }
    header{padding:20px 12px;border-bottom:1px solid #1f2937}
    h1{margin:0;font-size:22px}
    .bar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:14px 0}
    button{
      background:#111827;color:#e5e7eb;border:1px solid #374151;
      padding:10px 14px;border-radius:10px;cursor:pointer
    }
    button.active{outline:2px solid var(--brand)}
    main{max-width:900px;margin:12px auto;padding:12px}
    #stage{position:relative;display:inline-block}
    #video{display:none}
    #canvas{width: min(92vw, 860px); height: auto; background:#0b1220;border-radius:12px}
    .hint{color:#9ca3af;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¶ ÙˆØµÙ„Ø© â€“ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµØ§Ø¨Ø¹ Ù„Ù„Ø¹Ø²Ù</h1>
    <div class="bar">
      <button id="mode-piano" class="active">Ø¨ÙŠØ§Ù†Ùˆ</button>
      <button id="mode-drum">Ø·Ø¨Ù„</button>
      <button id="start">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ“·</button>
      <button id="install" hidden>ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â¬‡ï¸</button>
    </div>
  </header>

  <main>
    <div id="stage">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <div class="hint">Ù„Ù„Ø¹Ø²Ù: Ù‚Ø±Ù‘Ø¨ÙŠ Ø£ØµØ§Ø¨Ø¹Ùƒ Ù…Ù† Ø£Ø³ÙÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ ÙˆØ¶Ø¹ Â«Ø¨ÙŠØ§Ù†ÙˆÂ»ØŒ Ø£Ùˆ Ø§Ù„Ù…Ø³ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± ÙÙŠ ÙˆØ¶Ø¹ Â«Ø·Ø¨Ù„Â»</div>
  </main>

  <!-- Tone.js Ù„Ù„ØµÙˆØª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js" defer></script>

  <!-- MediaPipe Tasks (Hands) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" defer></script>

  <script>
  // ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù… =====
  const btnStart   = document.getElementById("start");
  const btnPiano   = document.getElementById("mode-piano");
  const btnDrum    = document.getElementById("mode-drum");
  const btnInstall = document.getElementById("install");
  const video  = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx    = canvas.getContext("2d");
  let currentMode = "piano";   // "piano" | "drum"
  let landmarker, running = false;

  // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª (Tone.js) =====
  const piano = new Tone.Sampler({
    urls: { "C4": "C4.mp3", "E4": "E4.mp3", "G4": "G4.mp3", "C5": "C5.mp3" }
  }).toDestination();
  const drum = new Tone.MembraneSynth().toDestination();

  // Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø¹ÙŠÙ†Ø§Øª Ø¨ÙŠØ§Ù†Ùˆ Ø¨Ø¹Ø¯ØŒ Ø³Ù†Ø³ØªØ¹Ù…Ù„ Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·:
  piano.add = ()=>{}; // placeholder ÙÙ‚Ø· Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ø¹ÙŠÙ†Ø§Øª ØµÙˆØª
  // ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±ÙØ¹ Ø£ØµÙˆØ§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙŠ Ù…Ø¬Ù„Ø¯ assets ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‡Ù†Ø§.

  function playPianoByY(y){
    // y Ø¨ÙŠÙ† 0..canvas.height â€“ ÙƒÙ„Ù…Ø§ Ù†Ø²Ù„Øª ÙŠØ¯Ùƒ Ù„Ù„Ø£Ø³ÙÙ„ ØªÙØ¹Ø²Ù Ù†ØºÙ…Ø©
    const zone = Math.floor((y / canvas.height) * 4); // 4 Ù…Ù†Ø§Ø·Ù‚
    const notes = ["C4","E4","G4","C5"];
    const note = notes[Math.max(0, Math.min(3, zone))];
    try { Tone.start(); piano.triggerAttackRelease(note, "8n"); } catch {}
  }
  function playDrumHit(){
    try { Tone.start(); drum.triggerAttackRelease("C2", "8n"); } catch {}
  }

  // ===== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =====
  btnPiano.onclick = ()=>{ currentMode="piano"; btnPiano.classList.add("active"); btnDrum.classList.remove("active"); }
  btnDrum.onclick  = ()=>{ currentMode="drum";  btnDrum.classList.add("active");  btnPiano.classList.remove("active"); }
  window.addEventListener("beforeinstallprompt", (e)=>{ e.preventDefault(); btnInstall.hidden=false; btnInstall.onclick=()=>e.prompt(); });

  // ===== ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ¨Ø¯Ø§ÙŠØ© MediaPipe Hands =====
  btnStart.onclick = async () => {
    if (running) return;
    running = true;
    // ÙÙŠØ¯ÙŠÙˆ
    const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
    video.srcObject = stream;
    await video.play();

    // Ù…Ù‚Ø§Ø³ Ø§Ù„Ù„ÙˆØ­Ø©
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;

    // ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ MediaPipe Hands
    const { HandLandmarker, FilesetResolver, DrawingUtils } = window;
    const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    landmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath:
          "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
      },
      numHands: 2,
      runningMode: "VIDEO"
    });

    const draw = new DrawingUtils(ctx);
    let lastTime = 0;

    async function render(t){
      const now = performance.now();
      if (!lastTime) lastTime = now;
      const results = landmarker.detectForVideo(video, now);

      // Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ®Ù„ÙÙŠØ©
      ctx.save();
      ctx.scale(-1,1); // Ù…Ø±Ø¢Ø©
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      // Ø±Ø³Ù… Ø§Ù„Ø¹Ø¸Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
      if (results?.landmarks) {
        for (const lm of results.landmarks) {
          draw.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS, {color:"#22d3ee", lineWidth:3});
          draw.drawLandmarks(lm, {color:"#f472b6", radius:3});

          // Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… (4) ÙƒÙ…Ø«Ø§Ù„
          const tip = lm[8]; // Ø±Ø£Ø³ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø©
          const x = (1 - tip.x) * canvas.width;
          const y = tip.y * canvas.height;

          // Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªÙØ¹ÙŠÙ„
          if (currentMode === "piano" && y > canvas.height * 0.75) {
            playPianoByY(y);
          } else if (currentMode === "drum" && y > canvas.height * 0.7) {
            playDrumHit();
          }

          // Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ
          ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2);
          ctx.strokeStyle = currentMode==="piano" ? "#22d3ee" : "#f59e0b";
          ctx.lineWidth = 2; ctx.stroke();
        }
      }
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
  };

  // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker Ù„Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø§ÙˆÙÙ„Ø§ÙŠÙ† =====
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }
  </script>
</body>
</html>
