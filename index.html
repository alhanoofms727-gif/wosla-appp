<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙˆØµÙ„Ø© â€“ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµØ§Ø¨Ø¹ Ù„Ù„Ø¹Ø²Ù</title>
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a;           /* ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ */
      --panel:#0b1220;
      --brand:#22d3ee;        /* Ø³Ù…Ø§ÙˆÙŠ */
      --brand2:#38bdf8;
      --accent:#f59e0b;       /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
      --text:#e5e7eb;         /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
      display:flex;flex-direction:column;min-height:100dvh;
    }
    header{
      padding:16px 12px;text-align:center;font-weight:700;font-size:20px;
    }
    .controls{
      position:relative; z-index:10;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding:10px 12px;
    }
    button{
      appearance:none;border:0; cursor:pointer;
      padding:10px 14px;border-radius:10px;
      background:#162032; color:var(--text); font-weight:700;
      outline:2px solid transparent; transition:.15s;
    }
    button:hover{transform:translateY(-1px)}
    button.active,button:focus{outline-color:var(--brand)}
    .primary{background:var(--brand); color:#03121a}
    .ghost{background:#162032}
    .status{ text-align:center; padding:6px 10px; min-height:24px; opacity:.9 }
    .status.error{color:#ffb4b4}
    .stage{
      position:relative; flex:1; display:flex; justify-content:center; align-items:center;
      padding:10px 12px 18px;
    }
    /* Ù…Ù‡Ù…: Ù†Ù…Ù†Ø¹ Ø§Ù„Ù€canvas/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø³Ø±Ù‚Ø© Ø§Ù„Ø¶ØºØ·Ø§Øª ÙÙˆÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    video,canvas{max-width:min(960px, 95vw); width:100%; height:auto; border-radius:12px}
    video,canvas{ display:block; background:#0b1220; }
    canvas{ position:absolute; inset:auto; pointer-events:none; }
    .frame{ position:relative; }
    footer{padding:8px 12px; text-align:center; opacity:.7; font-size:13px}
  </style>

  <!-- Ù…ÙƒØªØ¨Ø§Øª MediaPipe Ø§Ù„Ø±Ø³Ù…ÙŠØ© -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <header>ÙˆØµÙ„Ø© ğŸµ â€“ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµØ§Ø¨Ø¹ Ù„Ù„Ø¹Ø²Ù</header>

  <div class="controls" id="controls">
    <button id="btnStart" class="primary">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ“·</button>
    <button id="btnStop"  class="ghost" style="display:none">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â¹ï¸</button>
    <button id="btnPiano" class="ghost active">ğŸ¹ Ø¨ÙŠØ§Ù†Ùˆ</button>
    <button id="btnDrum"  class="ghost">ğŸ¥ Ø·Ø¨Ù„</button>
  </div>

  <div class="status" id="status">Ø¬Ø§Ù‡Ø². Ø§Ø¶ØºØ·ÙŠ Â«ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Â» Ø«Ù… Ø§Ø³Ù…Ø­ÙŠ Ø¨Ø§Ù„Ø¥Ø°Ù†.</div>

  <div class="stage">
    <div class="frame">
      <!-- playsinline/muted Ù„ØªØ³Ù…Ø­ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø¨Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ù‹Ø§ -->
      <video id="video" playsinline muted></video>
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <footer>Ø¬ÙÙ‡ÙÙ‘Ø² Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ â€” ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</footer>

  <script>
/* ===================== Ø¹Ù†Ø§ØµØ± DOM ===================== */
const btnStart  = document.getElementById('btnStart');
const btnStop   = document.getElementById('btnStop');
const btnPiano  = document.getElementById('btnPiano');
const btnDrum   = document.getElementById('btnDrum');
const statusEl  = document.getElementById('status');
const video     = document.getElementById('video');
const canvas    = document.getElementById('canvas');
const ctx       = canvas.getContext('2d');

let noteMode = 'piano';          // 'piano' Ø£Ùˆ 'drum'
let mpCamera = null;
let lastTipY = null, lastHitTime = 0;
const HIT_COOLDOWN = 120;        // ms
const SPEED_THRESHOLD = 8;       // Ø³Ø±Ø¹Ø© Ù†Ø²ÙˆÙ„ Ø§Ù„Ø¥ØµØ¨Ø¹ Ù„Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ "Ø¶Ø±Ø¨Ø©"

/* ===================== ØµÙˆØª (Web Audio) ===================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const master = audioCtx.createGain();
master.gain.value = 1.0; // ğŸ”Š Ù‚ÙˆÙŠ â€” Ø®ÙÙ‘Ø¶ÙŠÙ‡Ø§ Ù„Ùˆ Ø±ØºØ¨ØªÙ
master.connect(audioCtx.destination);

// Ø¯Ø±Ø¬Ø§Øª Ø¨Ø³ÙŠØ·Ø© C4..C5 (8 Ù…ÙØ§ØªÙŠØ­)
const FREQS = [261.63,293.66,329.63,349.23,392.00,440.00,493.88,523.25];

function playPiano(index){
  const i = Math.max(0, Math.min(FREQS.length-1, index));
  const f = FREQS[i];
  const osc  = audioCtx.createOscillator();
  const g    = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = f;
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.95, audioCtx.currentTime + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.35);
  osc.connect(g).connect(master);
  osc.start(); osc.stop(audioCtx.currentTime + 0.37);
}

function playDrum(){
  const dur = 0.15;
  const n = audioCtx.sampleRate * dur;
  const buffer = audioCtx.createBuffer(1, n, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<n;i++){ data[i] = (Math.random()*2-1) * (1 - i/n); } // Ø¶ÙˆØ¶Ø§Ø¡ ØªØ®ÙØª
  const src = audioCtx.createBufferSource(); src.buffer = buffer;
  const lp  = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1200;
  const g   = audioCtx.createGain(); g.gain.value = 1.2;
  src.connect(lp).connect(g).connect(master);
  src.start();
}

/* ===================== ÙˆØ§Ø¬Ù‡Ø© ===================== */
function setStatus(msg, isError=false){
  statusEl.textContent = msg || '';
  statusEl.className = 'status' + (isError ? ' error' : '');
}
btnPiano.addEventListener('click', ()=>{noteMode='piano';btnPiano.classList.add('active');btnDrum.classList.remove('active')});
btnDrum .addEventListener('click', ()=>{noteMode='drum'; btnDrum .classList.add('active');btnPiano.classList.remove('active')});

/* ===================== MediaPipe Hands ===================== */
const hands = new Hands({
  locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});
hands.onResults(onResults);

/* ===================== ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===================== */
async function startCamera(){
  try{
    // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù„Ø§ ØªØ´ØºÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„
    if (audioCtx.state === 'suspended') await audioCtx.resume();

    // MediaPipe Camera ØªØ¯ÙŠØ± getUserMedia Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§
    mpCamera = new Camera(video, {
      onFrame: async () => { await hands.send({ image: video }); },
      width:  640,
      height: 480
    });
    await mpCamera.start();

    // Ø¶Ø¨Ø· Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const wait = setInterval(()=>{
      if (video.videoWidth && video.videoHeight){
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        clearInterval(wait);
      }
    }, 60);

    btnStart.style.display='none';
    btnStop.style.display='inline-block';
    setStatus('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ âœ… Ø­Ø±Ù‘ÙƒÙŠ Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¹Ø²Ù.');

  }catch(e){
    console.error(e);
    setStatus('ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· HTTPS Ø«Ù… Ø£Ø¹ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.', true);
  }
}
function stopCamera(){
  try{
    if (mpCamera){ mpCamera.stop(); mpCamera = null; }
    const tracks = (video.srcObject && video.srcObject.getTracks) ? video.srcObject.getTracks() : [];
    tracks.forEach(t=>t.stop());
  }catch{}
  ctx.clearRect(0,0,canvas.width,canvas.height);
  btnStop.style.display='none';
  btnStart.style.display='inline-block';
  setStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
}
btnStart.addEventListener('click', startCamera, {passive:true});
btnStop .addEventListener('click', stopCamera , {passive:true});

// Ø£ÙŠ Ù†Ù‚Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ØªÙØ¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù† Ù„Ø²Ù…
['click','touchstart'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(audioCtx.state==='suspended') audioCtx.resume(); }, {passive:true, once:false});
});

/* ===================== Ù†ØªØ§Ø¦Ø¬ MediaPipe ===================== */
function onResults(results){
  // Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒÙ…Ø±Ø¢Ø©
  if (!canvas.width || !canvas.height){
    canvas.width  = results.image.width;
    canvas.height = results.image.height;
  }
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(results.image, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  if (!results.multiHandLandmarks || results.multiHandLandmarks.length===0){
    lastTipY = null;
    return;
  }
  const lm = results.multiHandLandmarks[0];

  // Ø±Ø³Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙˆØµÙ„Ø§Øª
  drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'#22d3ee', lineWidth:3});
  drawLandmarks (ctx, lm, {color:'#38bdf8', radius:3});

  // Ø·Ø±Ù Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© (landmark 8)
  const tip = lm[8];
  const x = (1 - tip.x) * canvas.width;   // Ù…Ø¹ Ø§Ù„Ù…Ø±Ø¢Ø©
  const y = tip.y * canvas.height;

  // ÙƒØ´Ù Ø¶Ø±Ø¨Ø© (Ù†Ø²ÙˆÙ„ Ø³Ø±ÙŠØ¹)
  let hit = false;
  if (lastTipY !== null){
    const speed = (y - lastTipY); // Ù…ÙˆØ¬Ø¨ = Ù†Ø²ÙˆÙ„
    const now = performance.now();
    if (speed > SPEED_THRESHOLD && (now - lastHitTime) > HIT_COOLDOWN){
      hit = true;
      lastHitTime = now;
    }
  }
  lastTipY = y;

  if (!hit) return;

  if (noteMode === 'piano'){
    const idx = Math.floor((x / canvas.width) * 8); // 8 Ù…ÙØ§ØªÙŠØ­
    playPiano(idx);
    highlightKey(idx);
  }else{
    playDrum();
    flashHit();
  }
}

/* ===================== Ù…Ø¤Ø«Ø± Ø¨ØµØ±ÙŠ Ø³Ø±ÙŠØ¹ ===================== */
function highlightKey(idx){
  const keyW = canvas.width / 8;
  ctx.save();
  ctx.globalAlpha = 0.22;
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(canvas.width - keyW*(idx+1), 0, keyW, canvas.height); // Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±Ø¢Ø©
  ctx.restore();
}
function flashHit(){
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.fillStyle = '#f59e0b';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}

/* ===================== ÙØ­ÙˆØµØ§Øª Ø³Ø±ÙŠØ¹Ø© ===================== */
(function(){
  if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    setStatus('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… getUserMedia. Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Chrome/Edge Ù…ÙØ­Ø¯Ù‘Ø«.', true);
  } else if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
    setStatus('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· HTTPS Ù„ØªØ¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', true);
  }
})();
  </script>
</body>
</html>
