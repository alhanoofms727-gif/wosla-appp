<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>وصلة – قراءة حركة الأصابع للعزف</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--fg:#e2e8f0;--muted:#94a3b8;--brand:#22d3ee;}
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Tajawal, Arial, sans-serif;
    }
    header{padding:18px 12px;border-bottom:1px solid #1f2937;text-align:center}
    h1{margin:0;font-size:22px}
    .bar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:14px 0}
    button{
      background:#111827;color:#e5e7eb;border:1px solid #374151;
      padding:10px 14px;border-radius:10px;cursor:pointer
    }
    button.active{outline:2px solid var(--brand)}
    main{max-width:980px;margin:20px auto;padding:0 12px}
    #stage{
      position:relative;background:var(--panel);border-radius:14px;
      min-height:320px; display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    #video{display:none}
    #canvas{width:100%;height:auto;display:block}
    .hint{color:var(--muted);font-size:13px;margin-top:10px;text-align:center}
    .status{color:#f59e0b;font-size:13px;margin-top:8px;text-align:center}
    .error{color:#f87171}
  </style>
</head>

<body>
  <header>
    <h1>🎶 وصلة – قراءة حركة الأصابع للعزف</h1>
    <div class="bar">
      <button id="mode-piano" class="active">بيانو</button>
      <button id="mode-drum">طبل</button>
      <button id="start">تشغيل الكاميرا 📷</button>
      <button id="stop"  style="display:none;">إيقاف الكاميرا ✋</button>
      <button id="install" hidden>تثبيت التطبيق ⬇️</button>
    </div>
  </header>

  <main>
    <div id="stage">
      <!-- نُخفي الفيديو ونرسمه على اللوحة (canvas). إن لم يعمل الرسم سيظهر الفيديو كبديل -->
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <div class="hint">اضغطي «تشغيل الكاميرا» ثم وافقي على الإذن. إن لم يظهر الإذن ادخلي إلى إعدادات المتصفح ← أذونات الموقع ← الكاميرا ← سماح.</div>
    <div id="status" class="status"></div>
  </main>

  <!-- ============ سكربت التطبيق ============ -->
  <script>
    // عناصر الواجهة
    const btnStart  = document.getElementById('start');
    const btnStop   = document.getElementById('stop');
    const btnPiano  = document.getElementById('mode-piano');
    const btnDrum   = document.getElementById('mode-drum');
    const btnInstall= document.getElementById('install');
    const video     = document.getElementById('video');
    const canvas    = document.getElementById('canvas');
    const ctx       = canvas.getContext('2d');
    const statusEl  = document.getElementById('status');

    let currentMode = 'piano';
    let stream = null;
    let animId = null;

    // رسائل حالة مبسطة
    function setStatus(msg, isError=false){
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (isError ? ' error' : '');
    }

    // تشغيل الكاميرا بعد «نقرة» المستخدم (مهم لأذونات المتصفح)
    async function startCamera(){
      try {
        setStatus('جاري طلب إذن الكاميرا…');
        const constraints = {
          audio: false,
          video: {
            facingMode: 'user',    // الأمامية. غيريها إلى 'environment' للخلفية
            width:  { ideal: 640 },
            height: { ideal: 480 }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        btnStart.style.display = 'none';
        btnStop.style.display  = 'inline-block';
        setStatus('الكاميرا تعمل ✅');

        // تجهيز القياسات والرسم على اللوحة
        canvas.width  = video.videoWidth  || 640;
        canvas.height = video.videoHeight || 480;
        drawFrame();
      } catch (err) {
        console.error('كاميرا:', err);
        setStatus('تعذر تشغيل الكاميرا. تأكدي من السماح بها من إعدادات المتصفح والجهاز.', true);
        // في حال رفض الإذن، نُظهر الفيديو ليظهر أي خطأ للمستخدم
        video.style.display = 'block';
      }
    }

    function stopCamera(){
      if (animId) cancelAnimationFrame(animId);
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      btnStop.style.display  = 'none';
      btnStart.style.display = 'inline-block';
      setStatus('تم إيقاف الكاميرا');
      // مسح اللوحة
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    // رسم إطار الفيديو على الـ canvas كمرآة
    function drawFrame(){
      try{
        ctx.save();
        ctx.scale(-1,1); // مرآة
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      }catch(e){ /* تجاهل الإطار عند عدم الجاهزية */ }
      animId = requestAnimationFrame(drawFrame);
    }

    // ربط الأزرار
    btnStart.addEventListener('click', startCamera);
    btnStop .addEventListener('click',  stopCamera);
    btnPiano.addEventListener('click', () => {
      currentMode = 'piano';
      btnPiano.classList.add('active'); btnDrum.classList.remove('active');
    });
    btnDrum.addEventListener('click', () => {
      currentMode = 'drum';
      btnDrum.classList.add('active');  btnPiano.classList.remove('active');
    });

    // زر تثبيت PWA إن كان مدعومًا
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); btnInstall.hidden = false;
      btnInstall.onclick = () => e.prompt();
    });

    // تشخيص سريع لبيئة الأذونات
    (async () => {
      if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
        setStatus('متصفحك لا يدعم getUserMedia. جرّبي تحديث المتصفح أو استخدام Chrome/Edge.', true);
      } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        setStatus('يجب أن يكون الرابط HTTPS لتعمل الكاميرا.', true);
      } else {
        setStatus('جاهز. اضغطي «تشغيل الكاميرا».');
      }
    })();

    // تسجيل Service Worker (للتثبيت والاوفلاين) — اختياري
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  ...
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <!-- كود استشعار الأصابع + الصوت -->
  <script>
    // ⚡ الصقي هنا الكود الذي أعطيتك إياه بالكامل
  </script>
</body>
</html>
/* ==================== استشعار الأصابع + الصوت ==================== */

// عناصر تحكم الوضع
let noteMode = 'piano'; // 'piano' أو 'drum'
btnPiano.addEventListener('click', () => noteMode='piano');
btnDrum .addEventListener('click', () => noteMode='drum');

// ---------- Web Audio (صوت قوي) ----------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const master = audioCtx.createGain();
// ⚠️ صوت قوي — عدّليه من 1.0 إذا رغبتِ
master.gain.value = 1.0; 
master.connect(audioCtx.destination);

// ملاحظات (دو ري مي فا صول لا سي دو)
const FREQS = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];

// تشغيل نغمة بيانو مبسطة (موجة نصف ساين مع مغلف سريع)
function playPiano(index){
  const f = FREQS[Math.max(0, Math.min(FREQS.length-1, index))];
  const osc  = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = f;
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.95, audioCtx.currentTime + 0.005); // هجوم سريع
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.35); // ذيل سريع
  osc.connect(gain).connect(master);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.37);
}

// طبلة (ضربة ضوضاء + فلتر)
function playDrum(){
  const dur = 0.15;
  const bufferSize = audioCtx.sampleRate * dur;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  // ضوضاء بيضاء
  for (let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * (1 - i/bufferSize); }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;

  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = 1200;

  const gain = audioCtx.createGain();
  gain.gain.value = 1.2; // قوي

  src.connect(filter).connect(gain).connect(master);
  src.start();
}

// ---------- MediaPipe Hands ----------
const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});
hands.onResults(onResults);

// نُشغّل MediaPipe بعد تشغيل الكاميرا بنجاح
let mpCamera = null;
async function ensureMP(){
  if (mpCamera) return;
  mpCamera = new Camera(video, {
    onFrame: async () => { await hands.send({ image: video }); },
    width: canvas.width || 640,
    height: canvas.height || 480
  });
  mpCamera.start();
}

// سنستدعيها من startCamera بعد تشغيل الكاميرا
const _oldStartCamera = startCamera;
startCamera = async function(){
  await _oldStartCamera();
  await ensureMP();
  // على أجهزة iOS/Android قد يتطلب الصوت تفاعلًا:
  if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

// رسم نقاط اليد + كشف الضربة/النغمة
let lastTipY = null;
let lastHitTime = 0;
const HIT_COOLDOWN = 120; // ملّي ثانية
function onResults(results){
  // نرسم الفيديو كمرآة (لدينا drawFrame بالفعل، لكن هنا نعيد الرسم لحظة الحساب)
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(results.image, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;

  const lm = results.multiHandLandmarks[0]; // يد واحدة
  // رسم المعالم (اختياري)
  drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'#22d3ee', lineWidth: 3});
  drawLandmarks(ctx, lm, {color:'#38bdf8', lineWidth: 1, radius: 3});

  // طرف السبابة (landmark 8)
  const tip = lm[8];
  const x = (1 - tip.x) * canvas.width;  // 1 - x لأننا قلبنا الصورة
  const y = tip.y * canvas.height;

  // سرعة نزول الأصبع (ضربة)
  let hit = false;
  if (lastTipY !== null){
    const speed = (y - lastTipY); // موجب = نزول
    const now = performance.now();
    if (speed > 8 && (now - lastHitTime) > HIT_COOLDOWN){
      hit = true;
      lastHitTime = now;
    }
  }
  lastTipY = y;

  if (!hit) return;

  if (noteMode === 'piano'){
    // نحدد النغمة حسب موقع x (8 مفاتيح)
    const idx = Math.floor((x / canvas.width) * 8);
    playPiano(idx);
    // لمسة بصرية سريعة
    highlightKey(idx);
  } else {
    playDrum();
    flashHit();
  }
}

// لمسة بصرية على الـ canvas عند العزف
function highlightKey(idx){
  const keyW = canvas.width / 8;
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(canvas.width - keyW*(idx+1), 0, keyW, canvas.height); // لأننا مرآة
  ctx.restore();
}
function flashHit(){
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.fillStyle = '#f59e0b';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}
</script>
