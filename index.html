<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙˆØµÙ„Ø© â€“ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµØ§Ø¨Ø¹ Ù„Ù„Ø¹Ø²Ù</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--fg:#e2e8f0;--muted:#94a3b8;--brand:#22d3ee;}
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Tajawal, Arial, sans-serif;
    }
    header{padding:18px 12px;border-bottom:1px solid #1f2937;text-align:center}
    h1{margin:0;font-size:22px}
    .bar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:14px 0}
    button{
      background:#111827;color:#e5e7eb;border:1px solid #374151;
      padding:10px 14px;border-radius:10px;cursor:pointer
    }
    button.active{outline:2px solid var(--brand)}
    main{max-width:980px;margin:20px auto;padding:0 12px}
    #stage{
      position:relative;background:var(--panel);border-radius:14px;
      min-height:320px; display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    #video{display:none}
    #canvas{width:100%;height:auto;display:block}
    .hint{color:var(--muted);font-size:13px;margin-top:10px;text-align:center}
    .status{color:#f59e0b;font-size:13px;margin-top:8px;text-align:center}
    .error{color:#f87171}
  </style>
</head>

<body>
  <header>
    <h1>ğŸ¶ ÙˆØµÙ„Ø© â€“ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµØ§Ø¨Ø¹ Ù„Ù„Ø¹Ø²Ù</h1>
    <div class="bar">
      <button id="mode-piano" class="active">Ø¨ÙŠØ§Ù†Ùˆ</button>
      <button id="mode-drum">Ø·Ø¨Ù„</button>
      <button id="start">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ“·</button>
      <button id="stop"  style="display:none;">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ âœ‹</button>
      <button id="install" hidden>ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â¬‡ï¸</button>
    </div>
  </header>

  <main>
    <div id="stage">
      <!-- Ù†ÙØ®ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ†Ø±Ø³Ù…Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© (canvas). Ø¥Ù† Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù… Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨Ø¯ÙŠÙ„ -->
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <div class="hint">Ø§Ø¶ØºØ·ÙŠ Â«ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Â» Ø«Ù… ÙˆØ§ÙÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù†. Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¥Ø°Ù† Ø§Ø¯Ø®Ù„ÙŠ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ â† Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ â† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â† Ø³Ù…Ø§Ø­.</div>
    <div id="status" class="status"></div>
  </main>

  <!-- ============ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============ -->
  <script>
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const btnStart  = document.getElementById('start');
    const btnStop   = document.getElementById('stop');
    const btnPiano  = document.getElementById('mode-piano');
    const btnDrum   = document.getElementById('mode-drum');
    const btnInstall= document.getElementById('install');
    const video     = document.getElementById('video');
    const canvas    = document.getElementById('canvas');
    const ctx       = canvas.getContext('2d');
    const statusEl  = document.getElementById('status');

    let currentMode = 'piano';
    let stream = null;
    let animId = null;

    // Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø©
    function setStatus(msg, isError=false){
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (isError ? ' error' : '');
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¹Ø¯ Â«Ù†Ù‚Ø±Ø©Â» Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù‡Ù… Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­)
    async function startCamera(){
      try {
        setStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦');
        const constraints = {
          audio: false,
          video: {
            facingMode: 'user',    // Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©. ØºÙŠØ±ÙŠÙ‡Ø§ Ø¥Ù„Ù‰ 'environment' Ù„Ù„Ø®Ù„ÙÙŠØ©
            width:  { ideal: 640 },
            height: { ideal: 480 }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        btnStart.style.display = 'none';
        btnStop.style.display  = 'inline-block';
        setStatus('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ âœ…');

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ø±Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©
        canvas.width  = video.videoWidth  || 640;
        canvas.height = video.videoHeight || 480;
        drawFrame();
      } catch (err) {
        console.error('ÙƒØ§Ù…ÙŠØ±Ø§:', err);
        setStatus('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ø¬Ù‡Ø§Ø².', true);
        // ÙÙŠ Ø­Ø§Ù„ Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†ØŒ Ù†ÙØ¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ÙŠØ¸Ù‡Ø± Ø£ÙŠ Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        video.style.display = 'block';
      }
    }

    function stopCamera(){
      if (animId) cancelAnimationFrame(animId);
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      btnStop.style.display  = 'none';
      btnStart.style.display = 'inline-block';
      setStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
      // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Ø§Ù„Ù€ canvas ÙƒÙ…Ø±Ø¢Ø©
    function drawFrame(){
      try{
        ctx.save();
        ctx.scale(-1,1); // Ù…Ø±Ø¢Ø©
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© */ }
      animId = requestAnimationFrame(drawFrame);
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btnStart.addEventListener('click', startCamera);
    btnStop .addEventListener('click',  stopCamera);
    btnPiano.addEventListener('click', () => {
      currentMode = 'piano';
      btnPiano.classList.add('active'); btnDrum.classList.remove('active');
    });
    btnDrum.addEventListener('click', () => {
      currentMode = 'drum';
      btnDrum.classList.add('active');  btnPiano.classList.remove('active');
    });

    // Ø²Ø± ØªØ«Ø¨ÙŠØª PWA Ø¥Ù† ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ù‹Ø§
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); btnInstall.hidden = false;
      btnInstall.onclick = () => e.prompt();
    });

    // ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
    (async () => {
      if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
        setStatus('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… getUserMedia. Ø¬Ø±Ù‘Ø¨ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome/Edge.', true);
      } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        setStatus('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· HTTPS Ù„ØªØ¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', true);
      } else {
        setStatus('Ø¬Ø§Ù‡Ø². Ø§Ø¶ØºØ·ÙŠ Â«ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Â».');
      }
    })();

    // ØªØ³Ø¬ÙŠÙ„ Service Worker (Ù„Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø§ÙˆÙÙ„Ø§ÙŠÙ†) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  ...
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <!-- ÙƒÙˆØ¯ Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ø£ØµØ§Ø¨Ø¹ + Ø§Ù„ØµÙˆØª -->
  <script>
    // âš¡ Ø§Ù„ØµÙ‚ÙŠ Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙƒ Ø¥ÙŠØ§Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  </script>
</body>
</html>
/* ==================== Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ø£ØµØ§Ø¨Ø¹ + Ø§Ù„ØµÙˆØª ==================== */

// Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ¶Ø¹
let noteMode = 'piano'; // 'piano' Ø£Ùˆ 'drum'
btnPiano.addEventListener('click', () => noteMode='piano');
btnDrum .addEventListener('click', () => noteMode='drum');

// ---------- Web Audio (ØµÙˆØª Ù‚ÙˆÙŠ) ----------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const master = audioCtx.createGain();
// âš ï¸ ØµÙˆØª Ù‚ÙˆÙŠ â€” Ø¹Ø¯Ù‘Ù„ÙŠÙ‡ Ù…Ù† 1.0 Ø¥Ø°Ø§ Ø±ØºØ¨ØªÙ
master.gain.value = 1.0; 
master.connect(audioCtx.destination);

// Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø¯Ùˆ Ø±ÙŠ Ù…ÙŠ ÙØ§ ØµÙˆÙ„ Ù„Ø§ Ø³ÙŠ Ø¯Ùˆ)
const FREQS = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];

// ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø¨ÙŠØ§Ù†Ùˆ Ù…Ø¨Ø³Ø·Ø© (Ù…ÙˆØ¬Ø© Ù†ØµÙ Ø³Ø§ÙŠÙ† Ù…Ø¹ Ù…ØºÙ„Ù Ø³Ø±ÙŠØ¹)
function playPiano(index){
  const f = FREQS[Math.max(0, Math.min(FREQS.length-1, index))];
  const osc  = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = f;
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.95, audioCtx.currentTime + 0.005); // Ù‡Ø¬ÙˆÙ… Ø³Ø±ÙŠØ¹
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.35); // Ø°ÙŠÙ„ Ø³Ø±ÙŠØ¹
  osc.connect(gain).connect(master);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.37);
}

// Ø·Ø¨Ù„Ø© (Ø¶Ø±Ø¨Ø© Ø¶ÙˆØ¶Ø§Ø¡ + ÙÙ„ØªØ±)
function playDrum(){
  const dur = 0.15;
  const bufferSize = audioCtx.sampleRate * dur;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  // Ø¶ÙˆØ¶Ø§Ø¡ Ø¨ÙŠØ¶Ø§Ø¡
  for (let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * (1 - i/bufferSize); }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;

  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = 1200;

  const gain = audioCtx.createGain();
  gain.gain.value = 1.2; // Ù‚ÙˆÙŠ

  src.connect(filter).connect(gain).connect(master);
  src.start();
}

// ---------- MediaPipe Hands ----------
const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});
hands.onResults(onResults);

// Ù†ÙØ´ØºÙ‘Ù„ MediaPipe Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­
let mpCamera = null;
async function ensureMP(){
  if (mpCamera) return;
  mpCamera = new Camera(video, {
    onFrame: async () => { await hands.send({ image: video }); },
    width: canvas.width || 640,
    height: canvas.height || 480
  });
  mpCamera.start();
}

// Ø³Ù†Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ù…Ù† startCamera Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
const _oldStartCamera = startCamera;
startCamera = async function(){
  await _oldStartCamera();
  await ensureMP();
  // Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© iOS/Android Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØµÙˆØª ØªÙØ§Ø¹Ù„Ù‹Ø§:
  if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

// Ø±Ø³Ù… Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯ + ÙƒØ´Ù Ø§Ù„Ø¶Ø±Ø¨Ø©/Ø§Ù„Ù†ØºÙ…Ø©
let lastTipY = null;
let lastHitTime = 0;
const HIT_COOLDOWN = 120; // Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©
function onResults(results){
  // Ù†Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒÙ…Ø±Ø¢Ø© (Ù„Ø¯ÙŠÙ†Ø§ drawFrame Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù… Ù„Ø­Ø¸Ø© Ø§Ù„Ø­Ø³Ø§Ø¨)
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(results.image, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;

  const lm = results.multiHandLandmarks[0]; // ÙŠØ¯ ÙˆØ§Ø­Ø¯Ø©
  // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'#22d3ee', lineWidth: 3});
  drawLandmarks(ctx, lm, {color:'#38bdf8', lineWidth: 1, radius: 3});

  // Ø·Ø±Ù Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© (landmark 8)
  const tip = lm[8];
  const x = (1 - tip.x) * canvas.width;  // 1 - x Ù„Ø£Ù†Ù†Ø§ Ù‚Ù„Ø¨Ù†Ø§ Ø§Ù„ØµÙˆØ±Ø©
  const y = tip.y * canvas.height;

  // Ø³Ø±Ø¹Ø© Ù†Ø²ÙˆÙ„ Ø§Ù„Ø£ØµØ¨Ø¹ (Ø¶Ø±Ø¨Ø©)
  let hit = false;
  if (lastTipY !== null){
    const speed = (y - lastTipY); // Ù…ÙˆØ¬Ø¨ = Ù†Ø²ÙˆÙ„
    const now = performance.now();
    if (speed > 8 && (now - lastHitTime) > HIT_COOLDOWN){
      hit = true;
      lastHitTime = now;
    }
  }
  lastTipY = y;

  if (!hit) return;

  if (noteMode === 'piano'){
    // Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù†ØºÙ…Ø© Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ x (8 Ù…ÙØ§ØªÙŠØ­)
    const idx = Math.floor((x / canvas.width) * 8);
    playPiano(idx);
    // Ù„Ù…Ø³Ø© Ø¨ØµØ±ÙŠØ© Ø³Ø±ÙŠØ¹Ø©
    highlightKey(idx);
  } else {
    playDrum();
    flashHit();
  }
}

// Ù„Ù…Ø³Ø© Ø¨ØµØ±ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù€ canvas Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø²Ù
function highlightKey(idx){
  const keyW = canvas.width / 8;
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(canvas.width - keyW*(idx+1), 0, keyW, canvas.height); // Ù„Ø£Ù†Ù†Ø§ Ù…Ø±Ø¢Ø©
  ctx.restore();
}
function flashHit(){
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.fillStyle = '#f59e0b';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}
</script>
