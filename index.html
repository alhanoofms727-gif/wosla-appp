<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>وصلة – قراءة حركة الأصابع للعزف</title>
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a;           /* كحلي غامق */
      --panel:#0b1220;
      --brand:#22d3ee;        /* سماوي */
      --brand2:#38bdf8;
      --accent:#f59e0b;       /* برتقالي */
      --text:#e5e7eb;         /* رمادي فاتح */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
      display:flex;flex-direction:column;min-height:100dvh;
    }
    header{
      padding:16px 12px;text-align:center;font-weight:700;font-size:20px;
    }
    .controls{
      position:relative; z-index:10;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding:10px 12px;
    }
    button{
      appearance:none;border:0; cursor:pointer;
      padding:10px 14px;border-radius:10px;
      background:#162032; color:var(--text); font-weight:700;
      outline:2px solid transparent; transition:.15s;
    }
    button:hover{transform:translateY(-1px)}
    button.active,button:focus{outline-color:var(--brand)}
    .primary{background:var(--brand); color:#03121a}
    .ghost{background:#162032}
    .status{ text-align:center; padding:6px 10px; min-height:24px; opacity:.9 }
    .status.error{color:#ffb4b4}
    .stage{
      position:relative; flex:1; display:flex; justify-content:center; align-items:center;
      padding:10px 12px 18px;
    }
    /* مهم: نمنع الـcanvas/الفيديو من سرقة الضغطات فوق الأزرار */
    video,canvas{max-width:min(960px, 95vw); width:100%; height:auto; border-radius:12px}
    video,canvas{ display:block; background:#0b1220; }
    canvas{ position:absolute; inset:auto; pointer-events:none; }
    .frame{ position:relative; }
    footer{padding:8px 12px; text-align:center; opacity:.7; font-size:13px}
  </style>

  <!-- مكتبات MediaPipe الرسمية -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <header>وصلة 🎵 – قراءة حركة الأصابع للعزف</header>

  <div class="controls" id="controls">
    <button id="btnStart" class="primary">تشغيل الكاميرا 📷</button>
    <button id="btnStop"  class="ghost" style="display:none">إيقاف الكاميرا ⏹️</button>
    <button id="btnPiano" class="ghost active">🎹 بيانو</button>
    <button id="btnDrum"  class="ghost">🥁 طبل</button>
  </div>

  <div class="status" id="status">جاهز. اضغطي «تشغيل الكاميرا» ثم اسمحي بالإذن.</div>

  <div class="stage">
    <div class="frame">
      <!-- playsinline/muted لتسمح بعض المتصفحات بعرض الفيديو فورًا -->
      <video id="video" playsinline muted></video>
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <footer>جُهِّز للعرض التعليمي — يعمل على الجوال والكمبيوتر</footer>

  <script>
/* ===================== عناصر DOM ===================== */
const btnStart  = document.getElementById('btnStart');
const btnStop   = document.getElementById('btnStop');
const btnPiano  = document.getElementById('btnPiano');
const btnDrum   = document.getElementById('btnDrum');
const statusEl  = document.getElementById('status');
const video     = document.getElementById('video');
const canvas    = document.getElementById('canvas');
const ctx       = canvas.getContext('2d');

let noteMode = 'piano';          // 'piano' أو 'drum'
let mpCamera = null;
let lastTipY = null, lastHitTime = 0;
const HIT_COOLDOWN = 120;        // ms
const SPEED_THRESHOLD = 8;       // سرعة نزول الإصبع لاعتبارها "ضربة"

/* ===================== صوت (Web Audio) ===================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const master = audioCtx.createGain();
master.gain.value = 1.0; // 🔊 قوي — خفّضيها لو رغبتِ
master.connect(audioCtx.destination);

// درجات بسيطة C4..C5 (8 مفاتيح)
const FREQS = [261.63,293.66,329.63,349.23,392.00,440.00,493.88,523.25];

function playPiano(index){
  const i = Math.max(0, Math.min(FREQS.length-1, index));
  const f = FREQS[i];
  const osc  = audioCtx.createOscillator();
  const g    = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = f;
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.95, audioCtx.currentTime + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.35);
  osc.connect(g).connect(master);
  osc.start(); osc.stop(audioCtx.currentTime + 0.37);
}

function playDrum(){
  const dur = 0.15;
  const n = audioCtx.sampleRate * dur;
  const buffer = audioCtx.createBuffer(1, n, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<n;i++){ data[i] = (Math.random()*2-1) * (1 - i/n); } // ضوضاء تخفت
  const src = audioCtx.createBufferSource(); src.buffer = buffer;
  const lp  = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1200;
  const g   = audioCtx.createGain(); g.gain.value = 1.2;
  src.connect(lp).connect(g).connect(master);
  src.start();
}

/* ===================== واجهة ===================== */
function setStatus(msg, isError=false){
  statusEl.textContent = msg || '';
  statusEl.className = 'status' + (isError ? ' error' : '');
}
btnPiano.addEventListener('click', ()=>{noteMode='piano';btnPiano.classList.add('active');btnDrum.classList.remove('active')});
btnDrum .addEventListener('click', ()=>{noteMode='drum'; btnDrum .classList.add('active');btnPiano.classList.remove('active')});

/* ===================== MediaPipe Hands ===================== */
const hands = new Hands({
  locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});
hands.onResults(onResults);

/* ===================== تشغيل/إيقاف الكاميرا ===================== */
async function startCamera(){
  try{
    // بعض المتصفحات لا تشغل الصوت إلا بعد تفاعل
    if (audioCtx.state === 'suspended') await audioCtx.resume();

    // MediaPipe Camera تدير getUserMedia داخليًا
    mpCamera = new Camera(video, {
      onFrame: async () => { await hands.send({ image: video }); },
      width:  640,
      height: 480
    });
    await mpCamera.start();

    // ضبط قياسات الرسم بعد بدء الفيديو
    const wait = setInterval(()=>{
      if (video.videoWidth && video.videoHeight){
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        clearInterval(wait);
      }
    }, 60);

    btnStart.style.display='none';
    btnStop.style.display='inline-block';
    setStatus('الكاميرا تعمل ✅ حرّكي إصبع السبابة للأسفل أمام الكاميرا للعزف.');

  }catch(e){
    console.error(e);
    setStatus('تعذّر تشغيل الكاميرا. تأكدي من إذن الكاميرا ومن أن الرابط HTTPS ثم أعيدي المحاولة.', true);
  }
}
function stopCamera(){
  try{
    if (mpCamera){ mpCamera.stop(); mpCamera = null; }
    const tracks = (video.srcObject && video.srcObject.getTracks) ? video.srcObject.getTracks() : [];
    tracks.forEach(t=>t.stop());
  }catch{}
  ctx.clearRect(0,0,canvas.width,canvas.height);
  btnStop.style.display='none';
  btnStart.style.display='inline-block';
  setStatus('تم إيقاف الكاميرا.');
}
btnStart.addEventListener('click', startCamera, {passive:true});
btnStop .addEventListener('click', stopCamera , {passive:true});

// أي نقرة على الصفحة تُعيد تفعيل الصوت إن لزم
['click','touchstart'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(audioCtx.state==='suspended') audioCtx.resume(); }, {passive:true, once:false});
});

/* ===================== نتائج MediaPipe ===================== */
function onResults(results){
  // رسم الفيديو كمرآة
  if (!canvas.width || !canvas.height){
    canvas.width  = results.image.width;
    canvas.height = results.image.height;
  }
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(results.image, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  if (!results.multiHandLandmarks || results.multiHandLandmarks.length===0){
    lastTipY = null;
    return;
  }
  const lm = results.multiHandLandmarks[0];

  // رسم النقاط والوصلات
  drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'#22d3ee', lineWidth:3});
  drawLandmarks (ctx, lm, {color:'#38bdf8', radius:3});

  // طرف السبابة (landmark 8)
  const tip = lm[8];
  const x = (1 - tip.x) * canvas.width;   // مع المرآة
  const y = tip.y * canvas.height;

  // كشف ضربة (نزول سريع)
  let hit = false;
  if (lastTipY !== null){
    const speed = (y - lastTipY); // موجب = نزول
    const now = performance.now();
    if (speed > SPEED_THRESHOLD && (now - lastHitTime) > HIT_COOLDOWN){
      hit = true;
      lastHitTime = now;
    }
  }
  lastTipY = y;

  if (!hit) return;

  if (noteMode === 'piano'){
    const idx = Math.floor((x / canvas.width) * 8); // 8 مفاتيح
    playPiano(idx);
    highlightKey(idx);
  }else{
    playDrum();
    flashHit();
  }
}

/* ===================== مؤثر بصري سريع ===================== */
function highlightKey(idx){
  const keyW = canvas.width / 8;
  ctx.save();
  ctx.globalAlpha = 0.22;
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(canvas.width - keyW*(idx+1), 0, keyW, canvas.height); // من اليمين بسبب المرآة
  ctx.restore();
}
function flashHit(){
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.fillStyle = '#f59e0b';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}

/* ===================== فحوصات سريعة ===================== */
(function(){
  if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    setStatus('متصفحك لا يدعم getUserMedia. استخدمي Chrome/Edge مُحدّث.', true);
  } else if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
    setStatus('يجب أن يكون الرابط HTTPS لتعمل الكاميرا.', true);
  }
})();
  </script>
</body>
</html>
